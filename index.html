<html lang="en">

<head>
  <meta charset="utf-8" />

  <title>Websocket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body>
  <h1 style="text-align: center;">Heart Rate Monitoring System</h1>
  
  <div class="row" style="padding: 10px;">
    <div class="col-lg-7">
      <canvas id="myChart" style="width:100%;"></canvas>

    </div>
    <div class="col-lg-3" style="text-align: center;">
      <h4>BPM</h4>
      <h1 id="bpm-h1"></h1>
      <p id = "bpm-state"></p>

    </div>
    <div class="col-lg-2">
      <div style="overflow: scroll;
      border: solid; height: 500px;
      border-radius: 9px;" id="display"></div>
      <br>
      <button class="btn btn-sm btn-dark" onclick="clearlog()">Clear Logs</button>
    </div>
    
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
  </script>


  <script>
    const labels = [];

    const data = {
      labels: labels,
      datasets: [{
        label: 'Signal',
        borderColor: 'rgb(255, 99, 132)',
        data: [],
        fill: false,
      }]
    };

    const config = {
      type: 'line',
      data: data,

      options: {

        responsive: true,
        elements: {
          point: {
            radius: 0
          }
        },
        plugins: {

          title: {
            display: true,
            text: 'Min and Max Settings'
          }
        },
        scales: {

          yAxes: [{
            ticks: {
              min: 40,
              max: 150,
              stepSize: 10
            }
          }]
        }
      },

    };

    const myChart = new Chart(
      document.getElementById('myChart'),
      config
    );

    function addData(chart, label, data) {
      chart.data.labels.push(label);
      // chart.data.datasets.forEach((dataset) => {
      //     dataset.data.push(data);
      // });

      chart.data.datasets[0].data.push(data);

      if (chart.data.datasets[0].data.length > 10) {
        chart.data.datasets[0].data.shift();
        labels.shift();
      }

      chart.update();
    }
  </script>

  <script>
    //var sock =new WebSocket("ws://localhost:5001");
    var sock = new WebSocket("ws://192.168.43.173:3000"); //replace this address with the one the node.js server prints out. keep port 3000
    var display = document.getElementById("display");
    var bpmDiv = document.getElementById("bpm-h1");
    var bpmState = document.getElementById("bpm-state");

    sock.onopen = function (event) {
      display.innerHTML += "connection succeeded <br />";
    };

    sock.onmessage = function (event) {
      console.log(event.data); //show received from server data in console of browser
      display.innerHTML = event.data + "<br />" + display.innerHTML; //add incoming message from server to the log screen previous string + new string(message)
      // updateChart(parseInt(event.data));
      if (event.data.charAt(0) === 'A') {  // average BPM 
        bpmDiv.innerHTML = parseInt(event.data.substring(1, event.data.length));
       //alert()
      }
      else if(event.data.charAt(0) === 'S'){ // finger status
        if (event.data.charAt(1) === '2'){
          bpmState.innerHTML = "<em>Please place your finger on the sensor</em>";
        }
        else if(event.data.charAt(1) === '3'){
          bpmState.innerHTML = "...";
        }
      }
      else { // bpm values to be plotted in chart
        addData(myChart, '', parseInt(event.data));
      }
     
    };
    function clearlog() {
      display.innerHTML = "";
    }
  </script>

</body>

</html>